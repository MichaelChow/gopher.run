---
title: "5.7 服务注册与服务发现、服务配置"
date: 2025-05-24T00:53:00Z
draft: false
weight: 5007
---

# 5.7 服务注册与服务发现、服务配置

- 官方文档：[http://www.cloudwego.io/zh/docs/kitex/tutorials/third-party/service_discovery/consul/](http://www.cloudwego.io/zh/docs/kitex/tutorials/third-party/service_discovery/consul/)
- CAP理论：
    - C: 一致性、A: 可用性、P: 分区容错性
    - 在工程实践中最多只能做到其中2个
<!-- 列布局开始 -->

![](/images/1fd24637-29b5-80dd-b8b3-eb8545f452bb/image_1fe24637-29b5-8071-b2fa-e247cff2eb52.jpg)

![](/images/1fd24637-29b5-80dd-b8b3-eb8545f452bb/image_1fe24637-29b5-808f-bb92-d7486d173c3e.jpg)


---

![](/images/1fd24637-29b5-80dd-b8b3-eb8545f452bb/image_1fe24637-29b5-80e8-9fe1-cd989ce59e54.jpg)

<!-- 列布局结束 -->





### 服务注册-Sever端

- consul: [https://developer.hashicorp.com/consul/docs/intro](https://developer.hashicorp.com/consul/docs/intro)
    ```shell
    go get github.com/kitex-contrib/registry-consul
    ```
- 服务注册：
    - 服务注册 demo/demo_proto/main.go
        ```go
        	r, err := consul.NewConsulRegister(conf.GetConf().Registry.RegistryAddress[0])
        	if err != nil {
        		log.Fatal(err)
        	}
        	opts = append(opts, server.WithRegistry(r))
        ```
    - 修改配置文件中的服务注册端口为consul的`8500`：demo/demo_proto/conf/test/conf.yaml 
- 启动容器：docker compose up -d
- 启动Sever端：
    ![](/images/1fd24637-29b5-80dd-b8b3-eb8545f452bb/image_1fe24637-29b5-804b-8682-f310650a7176.jpg)
    ![](/images/1fd24637-29b5-80dd-b8b3-eb8545f452bb/image_1fe24637-29b5-803f-89ea-c4bb4ca3ad24.jpg)
### 服务发现-Client端

```go
	r, err := consul.NewConsulResolver("127.0.0.1:8500")
	if err != nil {
		log.Fatal(err)
	}
	c, err := echoservice.NewClient("demo_proto", client.WithResolver(r))
	if err != nil {
		log.Fatal(err)
	}
	res, err := c.Echo(context.TODO(), &pbapi.Request{Message: "Hello"})
	if err != nil {
		log.Fatal(err)
	}
	fmt.Println(res.Message)
```



### 服务配置

- **方式一：配置文件。** File config: `conf.go` 解析yaml配置文件
    ![](/images/1fd24637-29b5-80dd-b8b3-eb8545f452bb/image_1ff24637-29b5-8014-8791-cea769c76855.jpg)
- **方式二：环境变量。**
    - Linux env：export APP_ENV=online
    - .env file：APP_ENV=online
    - Docker env：ENV GO_ENV=online
        - `go get github.com/joho/godotenv`
        ![](/images/1fd24637-29b5-80dd-b8b3-eb8545f452bb/image_1ff24637-29b5-80ac-8111-f098fbe868a1.jpg)
- **方式三：配置中心tcc。**一般和注册中心用同一个
    ![](/images/1fd24637-29b5-80dd-b8b3-eb8545f452bb/image_1ff24637-29b5-8031-9fc4-f8b6dee896c4.jpg)




